# Workflow for automating Rust crate release.

name: Release

permissions:
  pull-requests: write
  contents: write
  actions: write

on:
  push:
    branches:
      - main
      - fix-release

jobs:
  # Publish unpublished crates and create a git tag
  publish:
    name: Publish
    runs-on: ubuntu-latest
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Install cargo-release
        uses: aranya-project/install-action@main
        with:
          tool: cargo-release@0.25.15

      - name: Create tags
        id: tag
        run: cargo release tag -v --allow-branch fix-release,main --execute --no-confirm
        # Continue on error so we don't get a CI failure (red X) when no release is needed.
        # Each following step must check `steps.tag.outcome` (NOT `steps.tag.conclusion`).
        continue-on-error: true

      #- name: Publish to crates.io
      #  if: success() && steps.tag.outcome == 'success'
      #  run: cargo release publish -v --execute
      #  env:
      #    CARGO_REGISTRY_TOKEN: ${{ secrets.ARANYA_BOT_CRATESIO_CARGO_LOGIN_KEY }}

      - name: Push tags to github
        if: success() && steps.tag.outcome == 'success'
        run: cargo release push -v --allow-branch fix-release,main --execute --no-confirm
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Version
        run: |
          echo "VERSION=$(cargo metadata --format-version=1 --no-deps | jq --raw-output '.packages[0].version')" >> $GITHUB_OUTPUT
        id: version

    outputs:
      tag: v${{ steps.version.outputs.VERSION }}
      outcome: ${{ steps.tag.outcome }}

  release:
    needs:
      - publish
    if: ${{ needs.publish.outputs.outcome }} == 'success'
    uses: ./.github/workflows/publish.yml
    with:
      workflow: publish
      tag: ${{ needs.publish.outputs.tag }}
